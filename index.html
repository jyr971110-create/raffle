<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬ì „ì‹ ì²­ ì¶”ì²¨ v14 (ì•ˆì •í™” Â· ì´ë¦„í‘œì‹œ Â· ì¤‘ë³µë°©ì§€)</title>
  <style>
    :root{--bg:#f7f8fb;--card:#fff;--txt:#111827;--muted:#6b7280;--pri:#4f46e5;--ok:#16a34a;--bad:#e11d48;--border:#e5e7eb}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic',sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .title{font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:#f3f4f6;cursor:pointer}
    .btn:hover{background:#e5e7eb}
    .btn.pri{background:var(--pri);color:#fff}
    .btn.danger{background:#fee2e2;color:#991b1b}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .muted{color:var(--muted)}
    .input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-top:1px solid var(--border);text-align:left}
    .big{font-size:42px;font-weight:900;letter-spacing:4px}
    .center{text-align:center}
    /* ë°œí‘œí™”ë©´: ìš”ì²­ëŒ€ë¡œ í° ë°°ê²½ */
    .display{background:#fff;color:var(--txt);border-radius:16px;min-height:70vh;padding:16px;border:1px solid var(--border)}
    .display .box{background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px}
    .rank{color:var(--muted)}
    .waiting{color:#9ca3af;font-size:24px}
    .name{font-size:18px;font-weight:700;margin-top:6px}
    .small{font-size:12px}
    .alert{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d;border-radius:12px;padding:10px;margin:8px 0;display:none}
    @media (max-width:900px){.g2{grid-template-columns:1fr}.g3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap row">
      <div class="title">ì‚¬ì „ì‹ ì²­ ì¶”ì²¨</div>
      <div class="muted small">event: <span id="topEventId" class="mono"></span> <span class="muted">Â·</span> <span class="mono" id="shareLinkSmall"></span></div>
      <span class="muted small" style="margin-left:8px">v14</span>
      <div class="grow"></div>
      <div id="tabs" class="row"></div>
      <button class="btn" id="btnNew">ìƒˆ ì´ë²¤íŠ¸</button>
      <button class="btn" id="btnClearHash">ì£¼ì†Œ í•´ì‹œ ì§€ìš°ê¸°</button>
    </div>
  </div>

  <div class="wrap" id="boot"></div>
  <div class="wrap" id="page" style="display:none">
    <div id="globalError" class="alert"></div>
    <div class="grid g2" id="admin"></div>
    <div id="participant"></div>
    <div id="display"></div>
  </div>

  <script>
  'use strict';

  // ===== ìœ í‹¸ =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const key = (eventId, suffix) => `raffle:${eventId}:${suffix}`;
  const normId = (s)=>{ s=(s||'').toString(); let out=''; for(let i=0;i<s.length;i++){ const ch=s[i]; if(ch===' '||ch==='\\t'||ch==='\\n'||ch==='\\r'||ch==='-'||ch==='_') continue; out+=ch; } return out.toUpperCase(); };
  const ensureArr = (v)=> Array.isArray(v)? v : (v? [v] : []);

  function escapeHtml(s){return String(s).replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
  function download(filename, text){ const blob=new Blob([text],{type:'text/plain;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }
  function prizeForRank(rank){ return rank===1?state.prizes.rank1:rank===2?state.prizes.rank2:rank===3?state.prizes.rank3:state.prizes.rest }
  function rankPrizeList(){ return [state.prizes.rank1,state.prizes.rank2,state.prizes.rank3, ...Array(7).fill(state.prizes.rest)]; }

  // ===== ìƒíƒœ =====
  const state = {
    eventId:'',
    tab:'admin',
    registrants:[], // {empId,name}
    checkins:[],    // {empId,name,code,at}
    prizes:{rank1:'1ë“± ìƒí’ˆ',rank2:'2ë“± ìƒí’ˆ',rank3:'3ë“± ìƒí’ˆ',rest:'ì°¸ê°€ìƒ(4~10ë“±)'},
    winners:[]      // {rank,empId,name,code,at,prize}
  };

  // localStorage ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€
  let STORAGE_OK = true;
  try { localStorage.setItem('raffle:__probe','1'); localStorage.removeItem('raffle:__probe'); }
  catch(e){ STORAGE_OK=false; showError('ë¸Œë¼ìš°ì € ì €ì¥ì†Œ(localStorage)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ ì°½ì—ì„œ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'); }

  function showError(msg){ const g=$('#globalError'); if(!g) return; g.style.display='block'; g.textContent = msg; }

  // ===== ì €ì¥/ë¡œë“œ + ì¹˜ìœ  =====
  function saveAll(){
    if(!state.eventId) return true;
    try{
      localStorage.setItem(key(state.eventId,'registrants'), JSON.stringify(state.registrants));
      localStorage.setItem(key(state.eventId,'checkins'), JSON.stringify(state.checkins));
      localStorage.setItem(key(state.eventId,'prizes'), JSON.stringify(state.prizes));
      localStorage.setItem(key(state.eventId,'winners'), JSON.stringify(state.winners));
      return true;
    }catch(e){
      STORAGE_OK=false; showError('ì €ì¥ ì‹¤íŒ¨: ' + (e?.message||'localStorage ì˜¤ë¥˜') + ' â€” í™”ë©´ì€ ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      return false;
    }
  }
  function loadAll(){
    try{ state.registrants = healRegistrants(JSON.parse(localStorage.getItem(key(state.eventId,'registrants'))||'[]')); }catch{ state.registrants=[]; }
    try{ state.checkins = healCheckins(JSON.parse(localStorage.getItem(key(state.eventId,'checkins'))||'[]')); }catch{ state.checkins=[]; }
    try{ state.prizes = JSON.parse(localStorage.getItem(key(state.eventId,'prizes'))||'null') || state.prizes; }catch{}
    try{ state.winners = healWinners(JSON.parse(localStorage.getItem(key(state.eventId,'winners'))||'[]')); }catch{ state.winners=[]; }
  }

  function healRegistrants(arr){
    const out=[]; const seen=new Set();
    for(const r of ensureArr(arr)){
      if(!r || typeof r!=='object') continue;
      const empId = String(r.empId||'').trim(); const name = String(r.name||'').trim();
      const k = normId(empId); if(!k || seen.has(k)) continue; seen.add(k);
      out.push({empId,name});
    }
    return out;
  }
  function healCheckins(arr){
    // ë™ì¼ ì‚¬ë²ˆ ì¤‘ë³µ â†’ ê°€ì¥ ì´ë¥¸ at 1ê±´ë§Œ ìœ ì§€. ì˜ëª»ëœ í•­ëª© ì œê±°. code 4ìë¦¬ ë³´ì •.
    const map=new Map();
    for(const c of ensureArr(arr)){
      if(!c || typeof c!=='object') continue;
      const k = normId(c.empId||''); if(!k) continue;
      const entry = { empId:String(c.empId||''), name:String(c.name||''), code:String(c.code||'').padStart(4,'0'), at:Number(c.at)||Date.now() };
      const cur = map.get(k);
      if(!cur || entry.at < cur.at) map.set(k, entry);
    }
    return Array.from(map.values());
  }
  function healWinners(arr){
    // ìœ íš¨ í•­ëª©ë§Œ, ì‚¬ë²ˆ ì¤‘ë³µ ì œê±°, 1~10ë“±ìœ¼ë¡œ ì¬ì •ë ¬Â·ì¬ë²ˆí˜¸
    const temp=[];
    for(const w of ensureArr(arr)){
      if(!w || typeof w!=='object') continue;
      const k = normId(w.empId||''); if(!k) continue;
      const code = String(w.code||'').padStart(4,'0');
      temp.push({rank:Number(w.rank)||0, empId:String(w.empId||''), name:String(w.name||''), code, at:Number(w.at)||Date.now(), prize:String(w.prize||'')});
    }
    // ì‚¬ë²ˆ ì¤‘ë³µ ì œê±°(ê°€ì¥ ì•ì„  rank ìœ ì§€)
    temp.sort((a,b)=>a.rank-b.rank||a.at-b.at);
    const seen = new Set(); const out=[];
    for(const w of temp){ const k=normId(w.empId); if(seen.has(k)) continue; seen.add(k); out.push(w); if(out.length>=10) break; }
    // ë­í¬ ì¬ë¶€ì—¬ + prize ì¬ê³„ì‚°
    out.forEach((w,i)=>{ w.rank=i+1; w.prize = prizeForRank(w.rank); });
    return out;
  }

  // ===== ë¶€íŠ¸ìŠ¤íŠ¸ë© =====
  function showBootstrap(){
    const boot = $('#boot');
    $('#page').style.display='none';
    boot.innerHTML = `
      <div class="card" style="max-width:560px;margin:40px auto;">
        <h2 style="margin:0 0 8px 0;font-size:22px;font-weight:800">ì´ë²¤íŠ¸ ë§Œë“¤ê¸°</h2>
        <p class="muted small">ì˜ˆ: <span class="mono">ai-training-2025-09</span>. ê°™ì€ ì´ë²¤íŠ¸IDëŠ” ê°™ì€ ì €ì¥ê³µê°„ì„ ì”ë‹ˆë‹¤.</p>
        <div class="row" style="margin-top:8px">
          <input class="input mono grow" id="eventName" placeholder="ì´ë²¤íŠ¸ID ì…ë ¥" />
          <button class="btn pri" id="create">ì´ë²¤íŠ¸ ìƒì„±</button>
        </div>
      </div>`;
    $('#create').onclick = ()=>{
      const name = $('#eventName').value.trim();
      if(!name) return alert('ì´ë²¤íŠ¸IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      state.eventId = name;
      const p = new URLSearchParams(location.hash.replace('#',''));
      p.set('event', name); p.set('tab','admin');
      location.hash = p.toString();
      boot.innerHTML='';
      loadAll();
      renderAll();
  // ì´ë²¤íŠ¸ ìƒì„± ì§í›„ ìë™ìœ¼ë¡œ QR ìƒì„±
  setTimeout(()=>{
    const qrBtn=document.getElementById('qrShowBtn');
    if(qrBtn) qrBtn.click();
  },500);
    };
  }

  // ===== íƒ‘ë°” =====
  function renderTop(){
    $('#topEventId').textContent = state.eventId || '-';
    const tabs = [['admin','ì°¸ì—¬ì/ì¶”ì²¨(ì§„í–‰ì)'], ['participant','ì°¸ê°€ì'], ['display','ë°œí‘œ í™”ë©´']];
    const el = $('#tabs'); el.innerHTML='';
    tabs.forEach(([id,label])=>{
      const b=document.createElement('button'); b.className='btn';
      if(state.tab===id){ b.style.background='var(--pri)'; b.style.color='#fff'; }
      b.textContent=label; b.onclick=()=>{
        state.tab=id;
        const p = new URLSearchParams(location.hash.replace('#','')); p.set('event',state.eventId); p.set('tab',state.tab); location.hash=p.toString();
        renderAll();
      };
      el.appendChild(b);
    });
    $('#btnNew').onclick=()=>{ if(!confirm('í˜„ì¬ ì´ë²¤íŠ¸ì—ì„œ ë‚˜ê°€ê³  ìƒˆ ì´ë²¤íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤. (ë°ì´í„°ëŠ” ë³´ì¡´)')) return; state.eventId=''; location.hash=''; showBootstrap(); };
    $('#btnClearHash').onclick=()=>{ history.replaceState(null,'',location.pathname+location.search); state.eventId=''; showBootstrap(); };
    // ê³µìœ  ë§í¬ ë¯¸ë¦¬ ë³´ê¸°
    const link = state.eventId ? `${location.origin}${location.pathname}#event=${encodeURIComponent(state.eventId)}&tab=participant` : '';
    $('#shareLinkSmall').textContent = state.eventId? link : '';
  }

  // ===== ì–´ë“œë¯¼ =====
  function renderAdmin(){
    const root = $('#admin');
    if(state.tab!=='admin'){ root.innerHTML=''; return; }
    $('#page').style.display='block';
    $('#globalError').style.display = STORAGE_OK? 'none' : 'block';
    root.className='grid g2';

    const c1 = document.createElement('div'); c1.className='card'; c1.innerHTML=`
      <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:800">ì‚¬ì „ì‹ ì²­ì ëª…ë‹¨</h3>
      <p class="muted small">CSV ì—…ë¡œë“œ (ì—´: <span class="mono">empId,name</span> ë˜ëŠ” <span class="mono">ì‚¬ë²ˆ,ì´ë¦„</span>)</p>
      <div class="row" style="gap:8px;margin:8px 0 12px 0">
        <input type="file" id="csvFile" accept=".csv" />
        <button class="btn" id="sample">ìƒ˜í”Œ CSV</button>
        <button class="btn" id="clearReg">ëª…ë‹¨ ë¹„ìš°ê¸°</button>
      </div>
      <div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px" id="regTable"></div>`;
    const c2 = document.createElement('div'); c2.className='card'; c2.innerHTML=`
      <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:800">ì°¸ì—¬ì ì²´í¬ì¸ (ì‹¤ì‹œê°„)</h3>
      <p class="muted small">ì‚¬ë²ˆì„ ì…ë ¥í•˜ë©´ ì‚¬ì „ì‹ ì²­ í™•ì¸ í›„ 4ìë¦¬ ì°¸ì—¬ë²ˆí˜¸ê°€ ë°œê¸‰ë©ë‹ˆë‹¤. (ì¤‘ë³µ ìë™ ë°©ì§€)</p>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <span class="badge">ì‚¬ì „ì‹ ì²­ì ìˆ˜: <b id="cntReg">0</b></span>
        <span class="badge" style="background:#ecfdf5;color:#065f46">ì²´í¬ì¸ ìˆ˜: <b id="cntCheck">0</b></span>
        <span class="badge" style="background:#e0f2fe;color:#075985">ë‹¹ì²¨ ìˆ˜: <b id="cntWin">0</b></span>
      </div>
      <div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px" id="checkTable"></div>
      <div class="muted small" style="margin-top:8px">
        ì°¸ê°€ì ë§í¬: <span class="mono" id="shareLink"></span>
        <button class="btn" id="copyLink">ë§í¬ ë³µì‚¬</button>
      </div>`;
    const c3 = document.createElement('div'); c3.className='card'; c3.innerHTML=`
      <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:800">ìƒí’ˆ ì„¤ì •</h3>
      <div class="grid g3" style="gap:12px">
        <div><div class="muted small">1ë“± ìƒí’ˆ</div><input class="input" id="p1" /></div>
        <div><div class="muted small">2ë“± ìƒí’ˆ</div><input class="input" id="p2" /></div>
        <div><div class="muted small">3ë“± ìƒí’ˆ</div><input class="input" id="p3" /></div>
        <div class="g3" style="grid-column:1/-1"><div class="muted small">4~10ë“± ê³µí†µ ìƒí’ˆ</div><input class="input" id="prest" /></div>
      </div>
      <div class="row" style="gap:8px;margin-top:10px"><button class="btn pri" id="savePrize">ì €ì¥</button><button class="btn" id="resetPrize">ê¸°ë³¸ê°’</button></div>`;
    const c4 = document.createElement('div'); c4.className='card'; c4.innerHTML=`
      <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:800">ì¶”ì²¨</h3>
      <div class="row" style="gap:8px;margin-bottom:10px">
        <button class="btn pri" id="drawBtn">ì¶”ì²¨ ì‹œì‘</button>
        <button class="btn" id="openDisplay">ë°œí‘œ í™”ë©´ ìƒˆì°½</button>
        <button class="btn" id="exportCsv">ë‹¹ì²¨ê²°ê³¼ CSV</button>
        <button class="btn" id="resetW">ê²°ê³¼ ì´ˆê¸°í™”</button>
        <div class="grow"></div>
        <button class="btn danger" id="clearAll">ì „ì²´ ì‚­ì œ</button>
      </div>
      <div class="grid g2" id="winners"></div>`;

    root.innerHTML=''; root.append(c1,c2,c3,c4);

    // ì—…ë¡œë“œ
    $('#csvFile').onchange = (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const txt = String(reader.result||'').replace(/^\uFEFF/,'');
        const rows = parseCSV(txt);
        state.registrants = healRegistrants(rows);
        saveAll(); renderAdmin();
      };
      reader.readAsText(f,'utf-8');
    };
    $('#sample').onclick = ()=>{ const sample='empId,name\nA12345,í™ê¸¸ë™\nB99101,ê¹€ì‚¬ì›\nC88888,ì´ë¦¬ë”\n'; download('registrants-sample.csv', sample); };
    $('#clearReg').onclick = ()=>{ if(confirm('ì‚¬ì „ì‹ ì²­ì ëª…ë‹¨ì„ ë¹„ìš¸ê¹Œìš”?')){ state.registrants=[]; saveAll(); renderAdmin(); } };

    // ì¹´ìš´íŠ¸ & í…Œì´ë¸”
    $('#cntReg').textContent = state.registrants.length;
    $('#cntCheck').textContent = state.checkins.length;
    $('#cntWin').textContent = state.winners.length;
    $('#regTable').innerHTML = renderTable(['ì‚¬ë²ˆ','ì´ë¦„'], state.registrants.map(r=>[r.empId, r.name||'']));
    const checkRows = [...state.checkins].sort((a,b)=>a.at-b.at).map(c=>[c.code, c.empId, c.name||'', new Date(c.at).toLocaleString()]);
    $('#checkTable').innerHTML = renderTable(['ì°¸ì—¬ë²ˆí˜¸','ì‚¬ë²ˆ','ì´ë¦„','ì²´í¬ì¸ ì‹œê°'], checkRows);

    // ì°¸ê°€ì ë§í¬
    const link = state.eventId ? `${location.origin}${location.pathname}#event=${encodeURIComponent(state.eventId)}&tab=participant` : '';
    $('#shareLink').textContent = link;
    if(navigator.clipboard){ $('#copyLink').onclick = ()=> navigator.clipboard.writeText(link).then(()=>alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.')); }

    // ìƒí’ˆ
    $('#p1').value = state.prizes.rank1; $('#p2').value = state.prizes.rank2; $('#p3').value = state.prizes.rank3; $('#prest').value = state.prizes.rest;
    $('#savePrize').onclick = ()=>{ state.prizes={rank1:$('#p1').value,rank2:$('#p2').value,rank3:$('#p3').value,rest:$('#prest').value}; const ok=saveAll(); if(!ok) alert('ì €ì¥ ì‹¤íŒ¨ â€” í™”ë©´ì€ ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'); };
    $('#resetPrize').onclick = ()=>{ state.prizes={rank1:'1ë“± ìƒí’ˆ',rank2:'2ë“± ìƒí’ˆ',rank3:'3ë“± ìƒí’ˆ',rest:'ì°¸ê°€ìƒ(4~10ë“±)'}; saveAll(); renderAdmin(); };

    // ì¶”ì²¨/ì´ˆê¸°í™”
    $('#drawBtn').onclick = startDraw;
    $('#openDisplay').onclick = ()=> window.open(`#event=${encodeURIComponent(state.eventId)}&tab=display`, '_blank');
    $('#exportCsv').onclick = exportWinnersCSV;
    $('#resetW').onclick = ()=>{ if(!confirm('ë‹¹ì²¨ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return; state.winners=[]; const ok=saveAll(); renderAdmin(); renderDisplay(); if(!ok) alert('ì €ì¥ ì‹¤íŒ¨ â€” í™”ë©´ë§Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); };
    $('#clearAll').onclick = ()=>{
      if(!confirm('ì´ ì´ë²¤íŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      try{
        localStorage.removeItem(key(state.eventId,'registrants'));
        localStorage.removeItem(key(state.eventId,'checkins'));
        localStorage.removeItem(key(state.eventId,'prizes'));
        localStorage.removeItem(key(state.eventId,'winners'));
      }catch(e){ STORAGE_OK=false; showError('ì €ì¥ì†Œ ì‚­ì œ ì‹¤íŒ¨ â€” í™”ë©´ë§Œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.'); }
      state.registrants=[]; state.checkins=[]; state.prizes={rank1:'1ë“± ìƒí’ˆ',rank2:'2ë“± ìƒí’ˆ',rank3:'3ë“± ìƒí’ˆ',rest:'ì°¸ê°€ìƒ(4~10ë“±)'}; state.winners=[];
      renderAdmin(); renderDisplay();
    };

    // ë‹¹ì²¨ ì¹´ë“œ
    const wWrap = $('#winners'); wWrap.innerHTML='';
    for(let rank=1; rank<=10; rank++){
      const w = state.winners.find(x=>x.rank===rank);
      const div = document.createElement('div'); div.className='card'; div.style.padding='12px';
      div.innerHTML = w ? (`
        <div class="muted small">${rank}ë“±</div>
        <div style="font-weight:800">#${w.code} ${escapeHtml(w.name||'')} <span class="muted small">(${maskEmp(w.empId)})</span></div>
        <div class="muted small">ìƒí’ˆ: ${escapeHtml(prizeForRank(rank))}</div>
      `) : (`
        <div class="muted small">${rank}ë“±</div>
        <div class="muted">ë¯¸ì •</div>
      `);
      wWrap.appendChild(div);
    }
  }

  function startDraw(){
    try{
      // í•­ìƒ ì¹˜ìœ  í›„ ì§„í–‰ (undefined ì„ì—¬ ë°œìƒí•˜ë˜ ì˜¤ë¥˜ ë°©ì§€)
      state.registrants = healRegistrants(state.registrants);
      state.checkins   = healCheckins(state.checkins);
      state.winners    = healWinners(state.winners);

      if(state.checkins.length<1){ alert('ì²´í¬ì¸ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(state.winners.length>=10){ alert('ì´ë¯¸ 10ëª… ëª¨ë‘ ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤. [ê²°ê³¼ ì´ˆê¸°í™”] í›„ ë‹¤ì‹œ ì§„í–‰í•˜ì„¸ìš”.'); return; }

      const already = new Set(state.winners.map(w=>normId(w.empId)));
      const pool = state.checkins.filter(c=> c && normId(c.empId) && !already.has(normId(c.empId)));
      if(pool.length<1){ alert('ìƒˆë¡œ ì¶”ì²¨í•  ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const need = Math.min(10 - state.winners.length, pool.length);
      shuffle(pool);
      const picks = pool.slice(0, need);
      const prizeList = rankPrizeList().slice(state.winners.length, state.winners.length + picks.length);

      const now = Date.now();
      const winners = picks.map((c,i)=>({ rank: state.winners.length+i+1, empId:c.empId, name:c.name, code:c.code, at: now+i, prize: prizeList[i] }));
      state.winners = healWinners(state.winners.concat(winners)); // ìµœì¢… ì¬ì •ë ¬/ê²€ì¦

      const ok = saveAll();
      renderAdmin(); renderDisplay();
      if(!ok) alert('ì €ì¥ ì‹¤íŒ¨ â€” í™”ë©´ì—ëŠ” ë³´ì´ì§€ë§Œ ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

      // ì»¨í˜í‹° & íš¨ê³¼ìŒ (ì„ íƒì )
      if(typeof fireConfetti==='function') fireConfetti();
      if(typeof playFanfare==='function') playFanfare();
    }catch(e){
      console.error(e);
      showError('ì¶”ì²¨ ì¤‘ ì˜¤ë¥˜: '+(e?.message||e));
    }
  }

  // ===== ì°¸ê°€ì =====
  function renderParticipant(){
    const root = $('#participant');
    if(state.tab!=='participant'){ root.innerHTML=''; return; }
    $('#page').style.display='block';
    root.innerHTML = `
      <div class="card" style="max-width:560px;margin:0 auto">
        <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:800">ì‚¬ì „ì‹ ì²­ì í™•ì¸</h3>
        <p class="muted small">ì‚¬ë²ˆì„ ì…ë ¥í•´ ì°¸ì—¬ë²ˆí˜¸(4ìë¦¬)ë¥¼ ë°œê¸‰ë°›ìœ¼ì„¸ìš”. (ì¤‘ë³µ ì²´í¬ì¸ ë°©ì§€)</p>
        <div class="row" style="gap:8px;margin:8px 0">
          <input id="empInput" class="input mono grow" placeholder="ì‚¬ë²ˆ ì…ë ¥" />
          <button id="checkBtn" class="btn pri">í™•ì¸</button>
        </div>
        <div id="result"></div>
      </div>`;
    const submit = ()=>{
      try{
        const empIdRaw = $('#empInput').value.trim();
        const k = normId(empIdRaw);
        if(!k) return;
        const result = $('#result');

        const reg = state.registrants.find(r=> normId(r.empId)===k);
        if(!reg){
          result.innerHTML = `<div class="card" style="background:#fff1f2;border-color:#fecdd3"><div style="font-weight:700;color:#be123c">ì¸ì¦ ì‹¤íŒ¨</div><div class="muted small">ì‚¬ì „ì‹ ì²­ ëª…ë‹¨ì— ì—†ìŠµë‹ˆë‹¤. ì§„í–‰ìš”ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div></div>`;
          return;
        }
        const exist = state.checkins.find(c=> normId(c.empId)===k);
        if(exist){ result.innerHTML = successBox(exist.code, 'ì´ë¯¸ ì°¸ì—¬ë²ˆí˜¸ê°€ ë°œê¸‰ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }

        // ìƒˆ ì½”ë“œ ìƒì„± (0000~9999, ì¤‘ë³µ íšŒí”¼)
        const used = new Set(state.checkins.map(c=>c.code));
        let code=''; let tries=0;
        do{ code = String(Math.floor(Math.random()*10000)).padStart(4,'0'); tries++; }while(used.has(code)&&tries<20000);

        const entry = { empId: reg.empId, name: reg.name, code, at: Date.now() };
        state.checkins.push(entry);
        state.checkins = healCheckins(state.checkins);
        const ok = saveAll();

        result.innerHTML = successBox(code, 'ì°¸ì—¬ë²ˆí˜¸ê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderAdmin();
        if(!ok) alert('ì €ì¥ ì‹¤íŒ¨ â€” í™”ë©´ì—ëŠ” ë³´ì´ì§€ë§Œ ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      }catch(e){ showError('ì²´í¬ì¸ ì¤‘ ì˜¤ë¥˜: '+(e?.message||e)); }
    };
    $('#checkBtn').onclick = submit;
    $('#empInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') submit(); });
  }

  function successBox(code,msg){
    return `<div class="card" style="background:#ecfdf5;border-color:#bbf7d0;text-align:center">
      <div style="font-weight:700;color:#065f46">ì¸ì¦ ì„±ê³µ</div>
      <div class="muted small" style="margin-bottom:8px">${escapeHtml(msg)}</div>
      <div class="muted small">ë‹¹ì‹ ì˜ ì°¸ì—¬ë²ˆí˜¸</div>
      <div class="big mono">${code}</div>
      <div class="small muted" style="margin-top:6px">* ì´ ë²ˆí˜¸ë¡œ ì¶”ì²¨ì— ì°¸ì—¬í•©ë‹ˆë‹¤. ì‚¬ë²ˆì€ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>`;
  }

  // ===== ë°œí‘œ í™”ë©´ =====
  function renderDisplay(){
    const root = $('#display');
    if(state.tab!=='display'){ root.innerHTML=''; return; }
    $('#page').style.display='block';

    const boxes=[];
    for(let rank=1; rank<=10; rank++){
      const w = state.winners.find(x=>x.rank===rank);
      boxes.push(`<div class="box">
        <div class="row" style="justify-content:space-between;margin-bottom:6px">
          <div class="rank">${rank}ë“±</div>
          <div class="small muted">${escapeHtml(prizeForRank(rank))}</div>
        </div>
        <div class="center" style="padding:6px 0 4px 0">
          ${w ? `<div><div class="big mono">#${w.code}</div><div class="name">${escapeHtml(w.name||'')}</div></div>` : `<div class="waiting">ëŒ€ê¸°ì¤‘â€¦</div>`}
        </div>
      </div>`);
    }
    root.innerHTML = `<div class="display">
      <div class="center" style="margin-bottom:12px">
        <div style="font-size:22px;font-weight:800">ì¶”ì²¨ ê²°ê³¼</div>
        <div class="small muted">(1~3ë“± ê°œë³„ìƒí’ˆ, 4~10ë“± ë™ì¼ìƒí’ˆ)</div>
        <button id="enableSound" class="btn" style="margin-left:8px">ğŸ”Š ì‚¬ìš´ë“œ</button>
      </div>
      <div class="grid g2" style="gap:12px">${boxes.join('')}</div>
      <div class="center small muted" style="margin-top:12px">ë°œí‘œ í™”ë©´ì€ ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤. ì¶”ì²¨ì€ ì§„í–‰ì íƒ­ì—ì„œ ì‹œì‘í•˜ì„¸ìš”.</div>
    </div>`;

    const en=$('#enableSound'); if(en){ en.onclick=()=>{ try{ const AC=window.AudioContext||window.webkitAudioContext; if(AC){ if(!window._audioCtx) window._audioCtx=new AC(); if(window._audioCtx.state==='suspended') window._audioCtx.resume(); alert('ì‚¬ìš´ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); } }catch{} }; }
  }

  // ===== ì»¨í˜í‹° & íš¨ê³¼ìŒ(ì˜µì…˜) =====
  function fireConfetti(){
    const duration = 1200;
    const canvas = document.createElement('canvas');
    canvas.style.position='fixed'; canvas.style.left=0; canvas.style.top=0; canvas.style.width='100%'; canvas.style.height='100%'; canvas.style.pointerEvents='none';
    canvas.width=window.innerWidth; canvas.height=window.innerHeight; document.body.appendChild(canvas);
    const ctx=canvas.getContext('2d'); const colors=['#f87171','#fbbf24','#34d399','#60a5fa','#a78bfa','#f472b6'];
    const count=180; const parts=Array.from({length:count},()=>({x:Math.random()*canvas.width,y:-20-Math.random()*200,w:6+Math.random()*6,h:8+Math.random()*10,c:colors[Math|Math.random()*colors.length],vx:(Math.random()-0.5)*3,vy:2+Math.random()*4,a:Math.random()*Math.PI*2,spin:(Math.random()*0.2+0.05)*(Math.random()<0.5?-1:1)}));
    let start; function frame(ts){ if(!start) start=ts; const t=ts-start; ctx.clearRect(0,0,canvas.width,canvas.height);
      parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.a+=p.spin; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore(); });
      if(t<duration) requestAnimationFrame(frame); else document.body.removeChild(canvas);
    } requestAnimationFrame(frame);
  }
  function playFanfare(){
    try{
      const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return;
      if(!window._audioCtx) window._audioCtx=new AC(); const ctx=window._audioCtx; const now=ctx.currentTime+0.05;
      function tone(freq,t0,dur,type='triangle',gain=0.04){ const osc=ctx.createOscillator(); const g=ctx.createGain(); osc.type=type; osc.frequency.value=freq; g.gain.setValueAtTime(0.0001,now+t0); g.gain.exponentialRampToValueAtTime(gain,now+t0+0.02); g.gain.exponentialRampToValueAtTime(0.0001,now+t0+dur); osc.connect(g).connect(ctx.destination); osc.start(now+t0); osc.stop(now+t0+dur+0.05); }
      [523.25,659.25,783.99,1046.5].forEach((f,i)=>tone(f,i*0.12,0.25));
    }catch{}
  }

  // ===== í‘œ ë Œë” =====
  function renderTable(headers, rows){
    const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${escapeHtml(String(c||''))}</td>`).join('')}</tr>`).join('')}</tbody>`;
    return `<table>${thead}${tbody}</table>`;
  }

  function exportWinnersCSV(){
    if(state.winners.length===0){ alert('ë‚´ë³´ë‚¼ ë‹¹ì²¨ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const header = ['rank','code','empId','name','prize','at'];
    const rows = state.winners.map(w=>[w.rank,w.code,w.empId,w.name||'',prizeForRank(w.rank), new Date(w.at).toISOString()]);
    const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
    download(`${state.eventId||'event'}-winners.csv`, csv);
  }

  function parseCSV(text){
    text = String(text||'').replace(/^\uFEFF/,'');
    const lines = []; let cur='', inQ=false; let row=[];
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(ch==='"'){ if(inQ && nx==='"'){ cur+='"'; i++; } else { inQ=!inQ; } continue; }
      if(ch===',' && !inQ){ row.push(cur); cur=''; continue; }
      if((ch==='\n'||ch==='\r') && !inQ){ if(ch==='\r' && nx==='\n'){ i++; } row.push(cur); lines.push(row); cur=''; row=[]; continue; }
      cur+=ch;
    }
    if(cur.length>0 || row.length>0){ row.push(cur); lines.push(row); }
    if(lines.length===0) return [];
    // í—¤ë” ê²€ì‚¬
    let start=0; let empIdx=0, nameIdx=1;
    const head = lines[0].map(s=>String(s||'').trim().toLowerCase());
    const empKeyIdx = head.findIndex(h=> h==='empid' || h==='ì‚¬ë²ˆ');
    const nameKeyIdx = head.findIndex(h=> h==='name' || h==='ì´ë¦„');
    if(empKeyIdx !== -1 || nameKeyIdx !== -1){ start=1; if(empKeyIdx!==-1) empIdx=empKeyIdx; if(nameKeyIdx!==-1) nameIdx=nameKeyIdx; }
    const out=[]; const seen=new Set();
    for(let i=start;i<lines.length;i++){
      const cols = lines[i]; if(!cols) continue;
      const empId = String(cols[empIdx]||'').trim(); const name=String(cols[nameIdx]||'').trim();
      const k=normId(empId); if(!k || seen.has(k)) continue; seen.add(k);
      out.push({empId,name});
    }
    return out;
  }

  function maskEmp(emp){ if(!emp) return ''; const n=emp.length; if(n<=2) return '*'.repeat(n); return emp.slice(0,Math.ceil(n/2))+ '*'.repeat(n-Math.ceil(n/2)); }

  // ===== ë¼ìš°íŒ… =====
  function initFromHash(){
    const p = new URLSearchParams(location.hash.replace('#',''));
    const event = p.get('event'); const tab = p.get('tab');
    if(event){ state.eventId=event; loadAll(); $('#boot').innerHTML=''; $('#page').style.display='block'; }
    if(tab){ state.tab=tab; }
    if(!event){ showBootstrap(); } else { renderAll(); }
  }
  window.addEventListener('hashchange', initFromHash);

  function renderAll(){ renderTop(); renderAdmin(); renderParticipant(); renderDisplay(); }

  // ì‹œì‘
  initFromHash();
  </script>

  <!-- QR Code support (added) -->
  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <script>
  // Add a QR button next to the "ë§í¬ ë³µì‚¬" button and render a QR for the participant link
  (function(){
    let qrInitialized = false;

    function ensureQRButton(){
      try{
        const copyBtn = document.getElementById('copyLink');
        const shareSpan = document.getElementById('shareLink');
        if(!copyBtn || !shareSpan) return;

        // Avoid duplicating the button on re-renders
        if(document.getElementById('qrShowBtn')) return;

        const btn = document.createElement('button');
        btn.id = 'qrShowBtn';
        btn.className = 'btn';
        btn.style.marginLeft = '6px';
        btn.textContent = 'QR ë³´ê¸°';

        btn.onclick = function(){
          try{
            const url = (shareSpan.textContent || '').trim();
            if(!url){ alert('ì°¸ê°€ì ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.'); return; }

            // Create a container under the share line if not exists
            let wrap = document.getElementById('qrWrap');
            if(!wrap){
              wrap = document.createElement('div');
              wrap.id = 'qrWrap';
              wrap.className = 'card';
              wrap.style.marginTop = '8px';
              wrap.innerHTML = '<div class="muted small">ì°¸ê°€ì QR</div><div id="qrBox" style="padding-top:6px"></div>';
              // place right after the copy button's parent (the share line)
              const parent = copyBtn.parentElement || shareSpan.parentElement || document.body;
              parent.parentElement.insertBefore(wrap, parent.nextSibling);
            }
            const box = document.getElementById('qrBox');
            if(!box) return;

            QRCode.toCanvas(url, { errorCorrectionLevel:'M', margin:1, width:200 }, function(err, canvas){
              if(err){ alert(err); return; }
              box.innerHTML='';
              box.appendChild(canvas);
            });
          }catch(e){ alert('QR ìƒì„± ì˜¤ë¥˜: '+ (e && e.message ? e.message : e)); }
        };

        // Insert the QR button next to copy button
        copyBtn.parentElement.appendChild(btn);
      }catch(e){ /* silent */ }
    }

    // Observe DOM changes so the button survives re-renders
    const obs = new MutationObserver(()=> ensureQRButton());
    obs.observe(document.documentElement, { childList:true, subtree:true });

    // Also try shortly after load
    window.addEventListener('load', function(){
      setTimeout(ensureQRButton, 200);
      setTimeout(ensureQRButton, 800);
    });
  })();
  </script>
  <!-- /QR Code support -->

</body>
</html>